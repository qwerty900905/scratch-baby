<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>짱이의 성별은?</title>

<style>
  body{
    margin:0;
    background:#f4f6f8;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
    font-family: system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
  }

  .card{
    position:relative;
    width:90vw;
    max-width:380px;
    aspect-ratio: 3 / 4;
    border-radius:28px;
    background:#fff;
    box-shadow:0 18px 40px rgba(0,0,0,.16);
    overflow:hidden;
  }

  .title{
    position:absolute;
    top:18px;
    left:16px;
    right:16px;
    z-index:3;
    text-align:center;
    line-height:1.05;
  }
  .title .t1{
    font-size:50px;
    font-weight:900;
    color:#111;
  }
  .title .t2{
    margin-top:6px;
    font-size:50px;
    font-weight:900;
  }
  .boy{ color:#8DBBFF; }
  .girl{ color:#FF8FB5; }
  .rest{ color:#111; }

  .baby{
    position:absolute;
    inset:0;
    z-index:0;
  }

  .ticket{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    bottom:30px;
    width:78%;
    height:24%;
    border-radius:16px;
    overflow:hidden;
    background:#BFC5CF;
    z-index:2;
  }

  .reveal{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:none;
  }
  .revealText{
    font-size:50px;
    font-weight:900;
    background:rgba(255,255,255,.85);
    padding:14px 18px;
    border-radius:16px;
  }

  canvas{
    position:absolute;
    inset:0;
    touch-action:none;
  }

  .hint{
    position:absolute;
    bottom:14px;
    left:16px;
    right:16px;
    text-align:center;
    font-size:12px;
    color:#666;
    z-index:3;
  }

  /* 폭죽 캔버스 (카드 위 덮기) */
  #confettiCanvas{
    position:absolute;
    inset:0;
    z-index:6;
    pointer-events:none;
  }
</style>
</head>

<body>
<div class="card">
  <!-- 제목 -->
  <div class="title">
    <div class="t1">짱이의 성별은?</div>
    <div class="t2">
      <span class="boy">Boy</span>
      <span class="rest"> or </span>
      <span class="girl">Girl</span>
    </div>
  </div>

  <!-- 아기 얼굴 -->
  <svg class="baby" viewBox="0 0 300 400" xmlns="http://www.w3.org/2000/svg">
    <rect width="300" height="400" fill="#FFEFF4"/>

    <defs>
      <clipPath id="headClip">
        <circle cx="150" cy="180" r="78"/>
      </clipPath>
    </defs>

    <!-- 얼굴(정중앙 기준 축소 + 간격용 Y 보정) -->
    <g transform="translate(150 180) scale(0.92) translate(-150 -162)">
      <circle cx="150" cy="180" r="78" fill="#FFE0C6"/>

      <ellipse cx="75" cy="185" rx="16" ry="22" fill="#FFD3B8"/>
      <ellipse cx="225" cy="185" rx="16" ry="22" fill="#FFD3B8"/>

      <g clip-path="url(#headClip)">
        <path d="M138 120 C132 114 132 104 138 98"
              stroke="#7A4A2E" stroke-width="7" fill="none" stroke-linecap="round"/>
        <path d="M150 120 C144 112 146 102 156 98"
              stroke="#7A4A2E" stroke-width="7" fill="none" stroke-linecap="round"/>
        <path d="M162 120 C156 112 160 104 168 100"
              stroke="#7A4A2E" stroke-width="7" fill="none" stroke-linecap="round"/>
      </g>

      <circle cx="125" cy="170" r="5.5" fill="#3A2A20"/>
      <circle cx="175" cy="170" r="5.5" fill="#3A2A20"/>

      <circle cx="110" cy="195" r="14" fill="#F6A5A5" opacity="0.65"/>
      <circle cx="190" cy="195" r="14" fill="#F6A5A5" opacity="0.65"/>

      <circle cx="150" cy="182" r="2.2" fill="#E0B199"/>

      <circle cx="150" cy="210" r="18" fill="#6EC9F5"/>
      <circle cx="150" cy="210" r="10" fill="#AEE4FA"/>
      <circle cx="150" cy="210" r="4.5" fill="#5AB6E5"/>
    </g>
  </svg>

  <!-- 복권 -->
  <div class="ticket" id="ticket">
    <div class="reveal">
      <!-- ✅ 여기만 바꾸면 결과 텍스트 고정 -->
      <div id="resultText" class="revealText girl">Girl</div>
    </div>
    <canvas id="scratch"></canvas>
  </div>

  <!-- 폭죽 레이어 -->
  <canvas id="confettiCanvas"></canvas>

  <div class="hint">복권 부분만 손가락으로 긁어보세요</div>
</div>

<script>
(() => {
  // ====== 설정 ======
  const THRESHOLD = 0.30;     // 30% 이상이면 트리거
  const CHECK_EVERY_MS = 220; // 퍼센트 계산 주기(성능)
  const BRUSH = 22;

  // ====== 결과 가져오기(Boy/Girl) ======
  const resultEl = document.getElementById("resultText");
  // class에 girl 또는 boy가 붙어있음
  const isGirl = resultEl.classList.contains("girl");
  const palette = isGirl
    ? ["#FF8FB5", "#FFB3C7", "#FFC2D6", "#FFD1E3", "#FFE1EE"]  // 핑크 폭죽
    : ["#8DBBFF", "#A8CDFF", "#C1DDFF", "#D7E9FF", "#EEF6FF"]; // 파란 폭죽

  // ====== 스크래치 캔버스 ======
  const canvas = document.getElementById("scratch");
  const ctx = canvas.getContext("2d", { willReadFrequently: true });
  const ticket = document.getElementById("ticket");

  // ====== 폭죽 캔버스 ======
  const confetti = document.getElementById("confettiCanvas");
  const cctx = confetti.getContext("2d");

  let down = false;
  let lastCheck = 0;
  let fired = false; // ✅ 한번만 터지게

  function resizeAll(){
    const r = ticket.getBoundingClientRect();
    canvas.width = Math.floor(r.width);
    canvas.height = Math.floor(r.height);

    const card = document.querySelector(".card").getBoundingClientRect();
    confetti.width = Math.floor(card.width);
    confetti.height = Math.floor(card.height);

    // 스크래치 커버 다시 그림
    ctx.globalCompositeOperation = "source-over";
    ctx.fillStyle = "#9FA6B2";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.globalCompositeOperation = "destination-out";
  }

  function pos(e){
    const r = canvas.getBoundingClientRect();
    return { x: e.clientX - r.left, y: e.clientY - r.top };
  }

  function scratchAt(x,y){
    ctx.beginPath();
    ctx.arc(x,y,BRUSH,0,Math.PI*2);
    ctx.fill();
  }

  // ====== 긁힌 비율 계산(투명 픽셀 비율) ======
  function scratchedRatio(){
    const img = ctx.getImageData(0,0,canvas.width,canvas.height).data;
    let transparent = 0;
    for(let i=3;i<img.length;i+=4){
      if(img[i] === 0) transparent++;
    }
    return transparent / (img.length/4);
  }

  // ====== 폭죽(컨페티) ======
  function launchConfettiOnce(){
    if(fired) return;
    fired = true; // ✅ 이후에는 절대 안 터짐

    const W = confetti.width, H = confetti.height;
    const pieces = [];
    const N = 160;

    for(let i=0;i<N;i++){
      pieces.push({
        x: Math.random()*W,
        y: -20 - Math.random()*H*0.25,
        vx: (Math.random()-0.5)*2.4,
        vy: 2.4 + Math.random()*3.6,
        r: 3 + Math.random()*4,
        rot: Math.random()*Math.PI,
        vr: (Math.random()-0.5)*0.25,
        life: 0,
        maxLife: 150 + Math.random()*90,
        color: palette[Math.floor(Math.random()*palette.length)]
      });
    }

    function frame(){
      cctx.clearRect(0,0,W,H);

      for(const p of pieces){
        p.x += p.vx;
        p.y += p.vy;
        p.rot += p.vr;
        p.life += 1;
        p.vy += 0.03; // gravity

        cctx.fillStyle = p.color;
        cctx.save();
        cctx.translate(p.x, p.y);
        cctx.rotate(p.rot);
        cctx.fillRect(-p.r, -p.r, p.r*2, p.r*2);
        cctx.restore();
      }

      const alive = pieces.some(p => p.life < p.maxLife && p.y < H + 40);
      if(alive){
        requestAnimationFrame(frame);
      }else{
        cctx.clearRect(0,0,W,H);
      }
    }
    requestAnimationFrame(frame);
  }

  function maybeTrigger(){
    if(fired) return; // ✅ 이미 터졌으면 더 이상 체크할 필요도 없음
    const now = Date.now();
    if(now - lastCheck < CHECK_EVERY_MS) return;
    lastCheck = now;

    const ratio = scratchedRatio();
    if(ratio >= THRESHOLD){
      launchConfettiOnce();
    }
  }

  // ====== 이벤트 ======
  canvas.addEventListener("pointerdown", (e) => {
    down = true;
    const p = pos(e);
    scratchAt(p.x,p.y);
    maybeTrigger();
  });

  canvas.addEventListener("pointermove", (e) => {
    if(!down) return;
    const p = pos(e);
    scratchAt(p.x,p.y);
    maybeTrigger();
  });

  ["pointerup","pointerleave","pointercancel"].forEach(ev =>
    canvas.addEventListener(ev, () => down = false)
  );

  window.addEventListener("resize", resizeAll);
  resizeAll();
})();
</script>
</body>
</html>